<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Quick Review</title>

  <style>
    body {
      margin: 0;
      font-family: system-ui, sans-serif;
      background: #fafafa;
      color: #111;
    }

    .screen {
      display: none;
      height: 100vh;
      padding: 24px;
      box-sizing: border-box;
      text-align: center;
      flex-direction: column;
      justify-content: center;
    }

    .screen.active {
      display: flex;
    }

    h1 {
      font-size: 22px;
      margin-bottom: 16px;
    }

    .stars {
      display: flex;
      justify-content: center;
      gap: 14px;
      font-size: 42px;
      margin-top: 14px;
    }

    .star {
      cursor: pointer;
      user-select: none;
      color: #cfcfcf;
    }

    .star.active {
      color: #f4b400;
    }

    .stars.static {
      font-size: 34px;
      pointer-events: none;
    }

    #thanksOverlay {
      margin-top: 20px;
      opacity: 0;
      transform: translateY(10px);
      transition: opacity 0.4s ease, transform 0.4s ease;
    }

    #thanksOverlay.show {
      opacity: 1;
      transform: translateY(0);
    }

    .button {
      margin-top: 24px;
      padding: 14px;
      border-radius: 14px;
      background: #1a73e8;
      border: none;
      color: white;
      font-size: 16px;
    }

    textarea {
      width: 100%;
      height: 120px;
      border-radius: 14px;
      border: 1px solid #e0e0e0;
      padding: 14px;
      font-size: 15px;
      margin-top: 16px;
      resize: none;
      box-sizing: border-box;
    }
  </style>
</head>

<body>

<!-- SCREEN 1 -->
<div class="screen active" id="screen-overall">
  <h1 id="overallQuestion">How was your experience?</h1>

  <div class="stars" id="overallStars">
    <span class="star" data-value="1">â˜…</span>
    <span class="star" data-value="2">â˜…</span>
    <span class="star" data-value="3">â˜…</span>
    <span class="star" data-value="4">â˜…</span>
    <span class="star" data-value="5">â˜…</span>
  </div>

  <div id="thanksOverlay">
    <div>Thank you</div>
    <div class="stars static" id="confirmStars"></div>
  </div>
</div>

<!-- SCREEN 2 -->
<div class="screen" id="screen-details">
  <h1 id="detailTitle"></h1>
  <div class="stars" id="detailStars">
    <span class="star" data-value="1">â˜…</span>
    <span class="star" data-value="2">â˜…</span>
    <span class="star" data-value="3">â˜…</span>
    <span class="star" data-value="4">â˜…</span>
    <span class="star" data-value="5">â˜…</span>
  </div>
</div>

<!-- SCREEN 3 -->
<div class="screen" id="screen-questions">
  <h1 id="questionText"></h1>
  <textarea id="answerBox" placeholder="Write naturally â€” a few words is enough ðŸ™‚"></textarea>
  <button class="button" onclick="nextQuestion()">Next</button>
</div>

<!-- SCREEN 4 -->
<div class="screen" id="screen-review">
  <h1>Your Review</h1>
  <textarea id="reviewBox"></textarea>
  <button class="button" onclick="copyAndOpen()">Copy & Review on Google</button>
</div>

<script>
/* ================= CONFIG ================= */
const APPS_SCRIPT_URL =
  "https://script.google.com/macros/s/AKfycbw8b75zqQhe9paJ7M_0Sh1YybAezEPbDc1qA_IkGWy4Tkm6uNi_PZB-_IH5F2czFQtp/exec";

const CLIENT_TOKEN = "review-app-v1";

/* ================= STATE ================= */
let overallRating = 0;
let detailIndex = 0;
let questionIndex = 0;
let answers = [];
let details = {};

const detailCategories = ["Food", "Ambience", "Service"];
const questions = [
  "What was the best part of your visit?",
  "Was there any dish, drink, or detail that stood out?",
  "How did this place make you feel?",
  "What would you tell a friend about this place?"
];

/* ================= HELPERS ================= */
function showScreen(id) {
  document.querySelectorAll(".screen").forEach(s => s.classList.remove("active"));
  document.getElementById(id).classList.add("active");
}

function bindStars(container, callback) {
  container.querySelectorAll(".star").forEach(star => {
    star.onclick = () => {
      const val = Number(star.dataset.value);
      container.querySelectorAll(".star")
        .forEach(s => s.classList.toggle("active", s.dataset.value <= val));
      callback(val);
    };
  });
}

function resetStars(container) {
  container.querySelectorAll(".star").forEach(s => s.classList.remove("active"));
}

/* ================= OVERALL ================= */
bindStars(document.getElementById("overallStars"), rating => {
  overallRating = rating;
  document.getElementById("overallQuestion").style.display = "none";
  document.getElementById("overallStars").style.display = "none";

  const confirm = document.getElementById("confirmStars");
  confirm.innerHTML = "";
  for (let i = 1; i <= 5; i++) {
    const s = document.createElement("span");
    s.textContent = "â˜…";
    s.className = "star" + (i <= rating ? " active" : "");
    confirm.appendChild(s);
  }

  document.getElementById("thanksOverlay").classList.add("show");

  setTimeout(() => {
    detailIndex = 0;
    loadDetail();
  }, 1200);
});

/* ================= DETAILS ================= */
function loadDetail() {
  if (detailIndex >= detailCategories.length) {
    questionIndex = 0;
    document.getElementById("questionText").innerText = questions[0];
    showScreen("screen-questions");
    return;
  }

  const container = document.getElementById("detailStars");
  resetStars(container);

  document.getElementById("detailTitle").innerText =
    `Rate the ${detailCategories[detailIndex]}`;

  showScreen("screen-details");

  bindStars(container, rating => {
    details[detailCategories[detailIndex]] = rating;
    detailIndex++;
    setTimeout(loadDetail, 400);
  });
}

/* ================= QUESTIONS ================= */
function nextQuestion() {
  answers.push(document.getElementById("answerBox").value.trim());
  document.getElementById("answerBox").value = "";

  questionIndex++;
  if (questionIndex >= questions.length) {
    generateReview();
    return;
  }
  document.getElementById("questionText").innerText = questions[questionIndex];
}

/* ================= USER JSON ================= */
function buildUserResponseJSON() {
  return {
    business: {
      name: "Kapai Coffee House & Bistro",
      category: "Cafe",
      city: "Kanpur"
    },
    ratings: {
      overall: overallRating,
      food: details.Food,
      ambience: details.Ambience,
      service: details.Service
    },
    responses: {
      best_part: answers[0] || "",
      standout_detail: answers[1] || "",
      emotional_feel: answers[2] || "",
      recommendation_pitch: answers[3] || ""
    }
  };
}

/* ================= AI CALL (NO CORS) ================= */
async function generateReview() {
  showScreen("screen-review");

  const box = document.getElementById("reviewBox");
  box.value = "Writing your reviewâ€¦";

  try {
    const res = await fetch(APPS_SCRIPT_URL, {
      method: "POST",
      body: JSON.stringify({
        token: CLIENT_TOKEN,
        payload: buildUserResponseJSON()
      })
    });

    const data = await res.json();

    if (data.review) {
      box.value = data.review;
    } else {
      box.value =
        "BACKEND RESPONSE:\n\n" +
        JSON.stringify(data, null, 2);
    }

  } catch (err) {
    box.value =
      "FETCH ERROR:\n\n" +
      err.toString();
  }
}

/* ================= MAPS ================= */
function copyAndOpen() {
  const box = document.getElementById("reviewBox");
  box.select();
  document.execCommand("copy");

  window.location.href =
    "https://www.google.com/maps/place/Kapai+Coffee+house+and+Bistro/";
}
</script>

</body>
</html>
